<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrackMyReps</title>
<link rel="preconnect" href="https://oxpeybhsucryghtrnhmm.supabase.co">
<link rel="dns-prefetch" href="https://oxpeybhsucryghtrnhmm.supabase.co">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root {
  --bg:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;--card:#161616;
  --border:#242424;--lime:#D4FF00;--lime2:#b8e000;
  --blue:#4488FF;--orange:#FF6B35;--purple:#9B6DFF;
  --green:#00E676;--red:#FF4444;--text:#f0f0f0;--text2:#888;--text3:#555;
  --r:16px;--r2:24px;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif}
body{overflow-x:hidden}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes cartBounce{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.hidden{display:none!important}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
h1,h2,h3,h4{font-family:'Syne',sans-serif}
.brand{font-family:'Syne',sans-serif;font-weight:800;font-size:1.5rem;letter-spacing:-.5px}
.brand span{color:var(--lime)}
.page-title{font-size:2rem;font-weight:800;line-height:1.1}
.label{font-size:.75rem;text-transform:uppercase;letter-spacing:1px;color:var(--text2);font-weight:600}
.muted{color:var(--text2);font-size:.875rem}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:20px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 24px;border-radius:100px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-weight:600;font-size:.9rem;transition:all .2s;white-space:nowrap}
.btn-lime{background:var(--lime);color:#000}
.btn-lime:hover{background:var(--lime2);transform:translateY(-1px);box-shadow:0 8px 24px rgba(212,255,0,.3)}
.btn-ghost{background:transparent;color:var(--text);border:1px solid var(--border)}
.btn-ghost:hover{border-color:var(--lime);color:var(--lime)}
.btn-danger{background:rgba(255,68,68,.15);color:var(--red);border:1px solid rgba(255,68,68,.3)}
.btn-danger:hover{background:rgba(255,68,68,.25)}
.btn-sm{padding:8px 16px;font-size:.8rem}
.btn-icon{padding:10px;border-radius:12px}
.btn:disabled{opacity:.4;cursor:not-allowed}
.w100{width:100%}
.inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.9rem;transition:border-color .2s;outline:none}
.inp:focus{border-color:var(--lime)}
.inp::placeholder{color:var(--text3)}
select.inp{cursor:pointer}
.inp-group{display:flex;flex-direction:column;gap:6px}
.inp-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.badge{display:inline-block;padding:3px 10px;border-radius:100px;font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.badge-lime{background:rgba(212,255,0,.15);color:var(--lime)}
.badge-blue{background:rgba(68,136,255,.15);color:var(--blue)}
.badge-purple{background:rgba(155,109,255,.15);color:var(--purple)}
.badge-green{background:rgba(0,230,118,.15);color:var(--green)}
.badge-red{background:rgba(255,68,68,.15);color:var(--red)}
#toast{position:fixed;bottom:24px;right:24px;z-index:9999;background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:14px 20px;display:flex;align-items:center;gap:12px;transform:translateX(200%);transition:transform .3s ease;min-width:280px;box-shadow:0 20px 60px rgba(0,0,0,.5)}
#toast.show{transform:translateX(0)}
#toast.success{border-color:var(--green)}
#toast.error{border-color:var(--red)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);padding:28px;width:100%;max-width:520px;max-height:90vh;overflow-y:auto;animation:fadeUp .3s ease}
.modal-title{font-family:'Syne',sans-serif;font-weight:700;font-size:1.3rem;margin-bottom:20px}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--lime);border-radius:50%;animation:spin .8s linear infinite}
.loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;z-index:9998}
#auth-screen{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;position:relative;overflow:hidden}
.auth-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 20% 50%,rgba(212,255,0,.06) 0%,transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(68,136,255,.06) 0%,transparent 60%)}
.auth-card{width:100%;max-width:440px;position:relative;z-index:1;animation:fadeUp .5s ease}
.auth-logo{text-align:center;margin-bottom:40px}
.auth-tabs{display:flex;background:var(--bg3);border-radius:100px;padding:4px;margin-bottom:28px;border:1px solid var(--border)}
.auth-tab{flex:1;text-align:center;padding:10px;border-radius:100px;cursor:pointer;font-weight:600;font-size:.875rem;transition:all .2s;color:var(--text2)}
.auth-tab.active{background:var(--lime);color:#000}
.code-input{letter-spacing:4px;text-transform:uppercase;font-family:'Syne',sans-serif;font-weight:700;font-size:1rem;text-align:center}
#app{display:flex;min-height:100vh}
.sidebar{width:240px;background:var(--bg2);border-right:1px solid var(--border);padding:28px 16px;display:flex;flex-direction:column;gap:8px;position:fixed;top:0;left:0;height:100vh;z-index:100;transition:transform .3s}
.sidebar-brand{padding:0 8px 20px;border-bottom:1px solid var(--border);margin-bottom:8px}
.nav-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-radius:var(--r);cursor:pointer;color:var(--text2);font-weight:500;font-size:.9rem;transition:all .2s}
.nav-item:hover{color:var(--text);background:var(--bg3)}
.nav-item.active{color:var(--lime);background:rgba(212,255,0,.08)}
.ni-icon{font-size:1.1rem;width:20px;text-align:center}
.sidebar-footer{margin-top:auto}
.user-chip{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:var(--r);background:var(--bg3);border:1px solid var(--border);cursor:pointer}
.avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--lime),var(--blue));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;color:#000;flex-shrink:0}
.avatar-lg{width:48px;height:48px;font-size:1rem;border-radius:16px}
.main-content{margin-left:240px;flex:1;padding:32px;max-width:1200px}
.page{display:none}
.page.active{display:block;animation:fadeUp .3s ease}
.page-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px;flex-wrap:wrap;gap:12px}
.mobile-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg2);border-top:1px solid var(--border);padding:8px 16px 20px;z-index:100;justify-content:space-around}
.mnav-item{display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;padding:8px 12px;border-radius:12px;color:var(--text2);font-size:.7rem}
.mnav-item.active{color:var(--lime)}
.topbar{display:none;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:50}
.hamburger{display:none;background:none;border:none;cursor:pointer;padding:8px}
.ham-lines{display:flex;flex-direction:column;gap:5px}
.ham-lines span{display:block;width:22px;height:2px;background:var(--text);border-radius:2px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:20px;position:relative;overflow:hidden}
.stat-num{font-family:'Syne',sans-serif;font-size:2.2rem;font-weight:800;margin:4px 0}
.stat-accent{position:absolute;top:16px;right:16px;font-size:2rem;opacity:.2}
/* EXERCISE CARDS */
.ex-card{background:var(--card);border:2px solid var(--border);border-radius:var(--r2);padding:16px;display:flex;align-items:center;gap:12px;transition:all .2s;cursor:pointer;position:relative;overflow:hidden}
.ex-card:hover{border-color:#444;transform:translateY(-2px)}
.ex-card.in-cart{border-color:var(--lime);background:rgba(212,255,0,.04)}
.ex-card.in-cart .cart-check{opacity:1;transform:scale(1)}
.cart-check{position:absolute;top:10px;right:10px;width:22px;height:22px;background:var(--lime);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.75rem;opacity:0;transform:scale(0);transition:all .2s;color:#000;font-weight:800}
.ex-icon{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}
.ex-info{flex:1;min-width:0}
.ex-name{font-weight:600;font-size:.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ex-meta{color:var(--text2);font-size:.78rem;margin-top:2px}
/* CART */
.cart-panel{position:fixed;right:0;top:0;height:100vh;width:380px;background:var(--bg2);border-left:1px solid var(--border);z-index:200;display:flex;flex-direction:column;transform:translateX(100%);transition:transform .35s ease;box-shadow:-20px 0 60px rgba(0,0,0,.5)}
.cart-panel.open{transform:translateX(0)}
.cart-header{padding:24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.cart-title{font-family:'Syne',sans-serif;font-weight:700;font-size:1.1rem}
.cart-body{flex:1;overflow-y:auto;padding:16px}
.cart-footer{padding:16px;border-top:1px solid var(--border);flex-shrink:0}
.cart-item{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:10px;position:relative}
.cart-item-name{font-weight:600;font-size:.85rem;margin-bottom:10px;padding-right:24px}
.cart-day-sel{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:8px 12px;color:var(--text);font-size:.82rem;width:100%;margin-bottom:8px;outline:none;cursor:pointer}
.cart-day-sel:focus{border-color:var(--lime)}
.cart-sets-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.cart-mini-inp{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--text);font-size:.82rem;width:100%;outline:none;text-align:center}
.cart-mini-inp:focus{border-color:var(--lime)}
.cart-remove{position:absolute;top:10px;right:10px;background:rgba(255,68,68,.15);border:none;color:var(--red);cursor:pointer;font-size:.8rem;padding:3px 8px;border-radius:8px;font-weight:700}
.cart-remove:hover{background:rgba(255,68,68,.3)}
.cart-trigger{position:fixed;bottom:100px;right:24px;z-index:150;width:58px;height:58px;border-radius:50%;background:var(--lime);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.3rem;box-shadow:0 8px 32px rgba(212,255,0,.4);transition:all .2s}
.cart-trigger:hover{transform:scale(1.1)}
.cart-trigger.bounce{animation:cartBounce .3s ease}
.cart-count{position:absolute;top:-4px;right:-4px;width:20px;height:20px;background:var(--red);border-radius:50%;font-size:.65rem;font-weight:800;display:flex;align-items:center;justify-content:center;color:#fff;font-family:'Syne',sans-serif}
.cat-filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px}
.cat-chip{padding:6px 14px;border-radius:100px;background:var(--bg3);border:1px solid var(--border);cursor:pointer;font-size:.8rem;font-weight:600;color:var(--text2);transition:all .2s}
.cat-chip.active{background:var(--lime);color:#000;border-color:transparent}
.day-tabs{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;margin-bottom:20px}
.day-tab{padding:8px 16px;border-radius:100px;border:1px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;font-size:.85rem;font-weight:600;white-space:nowrap;transition:all .2s}
.day-tab.active{background:var(--lime);color:#000;border-color:transparent}
.day-tab:hover:not(.active){border-color:var(--lime);color:var(--lime)}
.workout-ex{background:var(--card);border:1px solid var(--border);border-radius:var(--r2);padding:16px;margin-bottom:12px}
.workout-ex.done{border-color:var(--green);opacity:.8}
.set-row{display:grid;grid-template-columns:40px 1fr 1fr 48px;gap:8px;align-items:center;margin-top:10px}
.set-num{background:var(--bg3);border-radius:8px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;color:var(--text2)}
.set-inp{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--text);font-size:.85rem;text-align:center;outline:none;width:100%}
.set-inp:focus{border-color:var(--lime)}
.check-btn{width:32px;height:32px;border-radius:10px;border:2px solid var(--border);background:transparent;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;font-size:.85rem}
.check-btn.checked{background:var(--green);border-color:var(--green)}
.chart-wrap{position:relative;height:200px}
.client-row{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--card);border:1px solid var(--border);border-radius:var(--r);margin-bottom:8px}
.code-display{background:rgba(212,255,0,.06);border:2px dashed rgba(212,255,0,.3);border-radius:var(--r2);padding:24px;text-align:center;margin-bottom:24px}
.code-big{font-family:'Syne',sans-serif;font-size:2.8rem;font-weight:800;color:var(--lime);letter-spacing:8px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.ex-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
.empty{text-align:center;padding:60px 20px;color:var(--text2)}
.empty-icon{font-size:3rem;margin-bottom:16px;opacity:.5}
.empty h3{font-family:'Syne',sans-serif;margin-bottom:8px;color:var(--text)}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .main-content{margin-left:0;padding:20px 16px 100px}
  .mobile-nav{display:flex}
  .topbar{display:flex}
  .hamburger{display:flex}
  .grid2,.grid3{grid-template-columns:1fr}
  .page-title{font-size:1.5rem}
  .cart-panel{width:100%}
  .cart-trigger{bottom:90px;right:16px}
  .inp-row{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="loading-screen" id="loading">
  <div class="brand">Track<span>MyReps</span></div>
  <div class="spinner"></div>
</div>

<div id="toast"><span id="toast-icon"></span><span id="toast-msg"></span></div>

<!-- AUTH -->
<div id="auth-screen" class="hidden">
  <div class="auth-bg"></div>
  <div class="auth-card">
    <div class="auth-logo">
      <div class="brand" style="font-size:2.2rem">Track<span>MyReps</span></div>
      <p class="muted" style="margin-top:6px">Your intelligent fitness companion</p>
    </div>
    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchTab('login')">Sign In</div>
      <div class="auth-tab" onclick="switchTab('signup')">Sign Up</div>
    </div>
    <div id="login-form">
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="inp-group"><label class="label">Email</label><input class="inp" id="l-email" type="email" placeholder="you@example.com"></div>
        <div class="inp-group"><label class="label">Password</label><input class="inp" id="l-pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
        <button class="btn btn-lime w100" style="margin-top:8px" onclick="login()" id="login-btn">Sign In</button>
      </div>
    </div>
    <div id="signup-form" class="hidden">
      <div style="display:flex;flex-direction:column;gap:12px">
        <div class="inp-group"><label class="label">Full Name</label><input class="inp" id="s-name" type="text" placeholder="Your full name"></div>
        <div class="inp-group"><label class="label">Email</label><input class="inp" id="s-email" type="email" placeholder="you@example.com"></div>
        <div class="inp-group"><label class="label">Password</label><input class="inp" id="s-pass" type="password" placeholder="Min 6 characters"></div>
        <div class="inp-group">
          <label class="label">I am a...</label>
          <select class="inp" id="s-role" onchange="toggleCodeField()">
            <option value="client">Client</option>
            <option value="trainer">Trainer</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div id="trainer-code-field" class="inp-group">
          <label class="label">Trainer Code (optional)</label>
          <input class="inp code-input" id="s-trainer-code" placeholder="e.g. JAY-4829" maxlength="8">
          <span class="muted" style="font-size:.75rem">Get this code from your trainer to link automatically</span>
        </div>
        <button class="btn btn-lime w100" style="margin-top:8px" onclick="signup()">Create Account</button>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div class="topbar">
    <button class="hamburger" onclick="toggleSidebar()"><div class="ham-lines"><span></span><span></span><span></span></div></button>
    <div class="brand" style="font-size:1.1rem">Track<span>MyReps</span></div>
    <div class="avatar" id="top-avatar" onclick="logout()" style="cursor:pointer">?</div>
  </div>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-brand"><div class="brand">Track<span>MyReps</span></div></div>
    <div id="nav-items"></div>
    <div class="sidebar-footer">
      <div class="user-chip" onclick="logout()">
        <div class="avatar" id="sidebar-avatar">?</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;font-size:.85rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" id="sidebar-name">User</div>
          <div class="muted" style="font-size:.75rem" id="sidebar-role">Role</div>
        </div>
        <span style="color:var(--text2);font-size:.8rem">â»</span>
      </div>
    </div>
  </div>
  <div class="mobile-nav" id="mobile-nav"></div>

  <!-- CART TRIGGER -->
  <button class="cart-trigger hidden" id="cart-trigger" onclick="toggleCart()">
    ğŸ›’<div class="cart-count hidden" id="cart-count">0</div>
  </button>

  <!-- CART PANEL -->
  <div class="cart-panel" id="cart-panel">
    <div class="cart-header">
      <div>
        <div class="cart-title">ğŸ›’ Exercise Cart</div>
        <div class="muted" style="font-size:.8rem;margin-top:2px"><span id="cart-count-label">0</span> exercises selected</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="toggleCart()">âœ• Close</button>
    </div>
    <div class="cart-body" id="cart-body">
      <div class="empty" style="padding:40px 20px"><div class="empty-icon">ğŸ›’</div><h3>Cart is empty</h3><p>Click exercises to add them</p></div>
    </div>
    <div class="cart-footer">
      <div class="inp-group" style="margin-bottom:10px">
        <label class="label">Plan Name</label>
        <input class="inp" id="cart-plan-name" placeholder="e.g. Malani â€“ 5 Day Split">
      </div>
      <div class="inp-group" style="margin-bottom:12px">
        <label class="label">Send to Client</label>
        <select class="inp" id="cart-client-sel"><option value="">â€” Select Client â€”</option></select>
      </div>
      <button class="btn btn-lime w100" onclick="sendPlan()">ğŸš€ Send Plan to Client</button>
      <button class="btn btn-ghost w100" style="margin-top:8px" onclick="clearCart()">Clear Cart</button>
    </div>
  </div>

  <div class="main-content" id="main-content">

    <!-- ADMIN -->
    <div class="page" id="page-admin-overview">
      <div class="page-header"><div><div class="label">Admin</div><h1 class="page-title">Overview</h1></div></div>
      <div class="grid3" style="margin-bottom:24px">
        <div class="stat-card"><div class="label">Exercises</div><div class="stat-num" id="stat-ex">â€”</div><div class="muted">Repository</div><div class="stat-accent">ğŸ‹ï¸</div></div>
        <div class="stat-card"><div class="label">Trainers</div><div class="stat-num" id="stat-tr">â€”</div><div class="muted">Active</div><div class="stat-accent">ğŸ‘¤</div></div>
        <div class="stat-card"><div class="label">Clients</div><div class="stat-num" id="stat-cl">â€”</div><div class="muted">Registered</div><div class="stat-accent">ğŸ’ª</div></div>
      </div>
      <div class="card"><div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px">All Users</div><div id="admin-users-list"></div></div>
    </div>

    <div class="page" id="page-admin-exercises">
      <div class="page-header"><div><div class="label">Repository</div><h1 class="page-title">Exercises</h1></div><button class="btn btn-lime" onclick="openExModal()">+ Add Exercise</button></div>
      <div class="cat-filters" id="admin-cat-filters">
        <div class="cat-chip active" onclick="filterAdminEx('All',this)">All</div>
        <div class="cat-chip" onclick="filterAdminEx('Legs',this)">ğŸ¦µ Legs</div>
        <div class="cat-chip" onclick="filterAdminEx('Chest',this)">ğŸ’ª Chest</div>
        <div class="cat-chip" onclick="filterAdminEx('Back',this)">ğŸ‹ï¸ Back</div>
        <div class="cat-chip" onclick="filterAdminEx('Shoulders',this)">â¬†ï¸ Shoulders</div>
        <div class="cat-chip" onclick="filterAdminEx('Arms',this)">ğŸ’ª Arms</div>
        <div class="cat-chip" onclick="filterAdminEx('Core',this)">ğŸ¯ Core</div>
        <div class="cat-chip" onclick="filterAdminEx('Cardio',this)">ğŸƒ Cardio</div>
      </div>
      <div id="admin-ex-list" class="ex-grid"></div>
    </div>

    <div class="page" id="page-admin-users">
      <div class="page-header"><div><div class="label">Manage</div><h1 class="page-title">All Users</h1></div><button class="btn btn-ghost btn-sm" onclick="loadAllUsers()">â†» Refresh</button></div>
      <div id="admin-users-full"></div>
    </div>

    <!-- TRAINER -->
    <div class="page" id="page-trainer-overview">
      <div class="page-header"><div><div class="label">Trainer Dashboard</div><h1 class="page-title">Welcome ğŸ‘‹</h1></div></div>
      <div class="code-display">
        <div class="label" style="margin-bottom:10px">Your Trainer Code â€” share with clients</div>
        <div class="code-big" id="trainer-code-display">â€”â€”</div>
        <button class="btn btn-ghost btn-sm" style="margin-top:14px" onclick="copyCode()">ğŸ“‹ Copy Code</button>
      </div>
      <div class="grid2" style="margin-bottom:24px">
        <div class="stat-card"><div class="label">My Clients</div><div class="stat-num" id="t-stat-clients">â€”</div><div class="muted">Linked to you</div><div class="stat-accent">ğŸ‘¥</div></div>
        <div class="stat-card"><div class="label">Plans Sent</div><div class="stat-num" id="t-stat-plans">â€”</div><div class="muted">Total assigned</div><div class="stat-accent">ğŸ“‹</div></div>
      </div>
      <div class="card"><div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px">My Clients</div><div id="trainer-clients-mini"></div></div>
    </div>

    <div class="page" id="page-trainer-build">
      <div class="page-header">
        <div><div class="label">Build & Send</div><h1 class="page-title">Create Plan</h1></div>
        <div class="muted" style="align-self:center">Tap exercises â†’ set day/sets â†’ send to client</div>
      </div>
      <div class="cat-filters" id="trainer-cat-filters">
        <div class="cat-chip active" onclick="filterTrainerEx('All',this)">All</div>
        <div class="cat-chip" onclick="filterTrainerEx('Legs',this)">ğŸ¦µ Legs</div>
        <div class="cat-chip" onclick="filterTrainerEx('Chest',this)">ğŸ’ª Chest</div>
        <div class="cat-chip" onclick="filterTrainerEx('Back',this)">ğŸ‹ï¸ Back</div>
        <div class="cat-chip" onclick="filterTrainerEx('Shoulders',this)">â¬†ï¸ Shoulders</div>
        <div class="cat-chip" onclick="filterTrainerEx('Arms',this)">ğŸ’ª Arms</div>
        <div class="cat-chip" onclick="filterTrainerEx('Core',this)">ğŸ¯ Core</div>
        <div class="cat-chip" onclick="filterTrainerEx('Cardio',this)">ğŸƒ Cardio</div>
      </div>
      <div id="trainer-ex-grid" class="ex-grid"></div>
    </div>

    <div class="page" id="page-trainer-clients">
      <div class="page-header"><div><div class="label">Manage</div><h1 class="page-title">My Clients</h1></div></div>
      <div id="trainer-clients-full"></div>
    </div>

    <div class="page" id="page-trainer-plans">
      <div class="page-header"><div><div class="label">Sent Plans</div><h1 class="page-title">Active Plans</h1></div></div>
      <div id="trainer-plans-list"></div>
    </div>

    <!-- CLIENT -->
    <div class="page" id="page-client-today">
      <div class="page-header"><div><div class="label">Today's Workout</div><h1 class="page-title" id="client-day-label">â€”</h1></div></div>
      <div class="day-tabs" id="client-day-tabs"></div>
      <div id="client-workout-list"></div>
    </div>

    <div class="page" id="page-client-progress">
      <div class="page-header"><div><div class="label">Analytics</div><h1 class="page-title">My Progress</h1></div><button class="btn btn-lime btn-sm" onclick="openMeasurementModal()">+ Log Weight</button></div>
      <div class="grid2" style="margin-bottom:24px">
        <div class="stat-card"><div class="label">Current Weight</div><div class="stat-num" id="current-weight">â€”</div><div class="muted">kg</div><div class="stat-accent">âš–ï¸</div></div>
        <div class="stat-card"><div class="label">Sessions Done</div><div class="stat-num" id="workouts-done">â€”</div><div class="muted">This week</div><div class="stat-accent">ğŸ”¥</div></div>
      </div>
      <div class="card" style="margin-bottom:16px"><div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px">Weight History</div><div class="chart-wrap"><canvas id="weight-chart"></canvas></div></div>
      <div class="card"><div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:16px">Weekly Volume (reps)</div><div class="chart-wrap"><canvas id="volume-chart"></canvas></div></div>
    </div>

    <div class="page" id="page-client-plan">
      <div class="page-header"><div><div class="label">Your Program</div><h1 class="page-title">My Plan</h1></div></div>
      <div id="client-plan-view"></div>
    </div>

    <div class="page" id="page-client-profile">
      <div class="page-header"><div><div class="label">Account</div><h1 class="page-title">Profile</h1></div><button class="btn btn-ghost btn-sm" onclick="logout()">Sign Out</button></div>
      <div class="card" style="max-width:480px">
        <div style="display:flex;align-items:center;gap:16px;margin-bottom:24px">
          <div class="avatar avatar-lg" id="profile-avatar">?</div>
          <div><div style="font-family:'Syne',sans-serif;font-size:1.3rem;font-weight:700" id="profile-name">â€”</div><div class="muted" id="profile-email">â€”</div><div style="margin-top:8px" id="profile-badge"></div></div>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:20px">
          <div style="font-family:'Syne',sans-serif;font-weight:700;margin-bottom:12px">Body Weight Log</div>
          <div id="measurements-table"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay hidden" id="ex-modal">
  <div class="modal">
    <div class="modal-title" id="ex-modal-title">Add Exercise</div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div class="inp-group"><label class="label">Name</label><input class="inp" id="ex-name" placeholder="e.g. Hack Squat"></div>
      <div class="inp-group"><label class="label">Category</label><select class="inp" id="ex-cat"><option>Legs</option><option>Chest</option><option>Back</option><option>Shoulders</option><option>Arms</option><option>Core</option><option>Cardio</option></select></div>
      <div class="inp-row">
        <div class="inp-group"><label class="label">Default Sets</label><input class="inp" id="ex-sets" type="number" placeholder="3"></div>
        <div class="inp-group"><label class="label">Default Reps</label><input class="inp" id="ex-reps" placeholder="10-15"></div>
      </div>
      <div class="inp-group"><label class="label">Tutorial URL</label><input class="inp" id="ex-url" placeholder="https://youtube.com/..."></div>
      <div class="inp-group"><label class="label">Notes / Cues</label><textarea class="inp" id="ex-notes" rows="2" placeholder="Coaching cues..."></textarea></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-ghost" style="flex:1" onclick="closeExModal()">Cancel</button>
        <button class="btn btn-lime" style="flex:1" onclick="saveExercise()">Save</button>
      </div>
    </div>
    <input type="hidden" id="ex-editing-id">
  </div>
</div>

<div class="modal-overlay hidden" id="meas-modal">
  <div class="modal">
    <div class="modal-title">Log Body Weight</div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <div class="inp-group"><label class="label">Weight (kg)</label><input class="inp" id="meas-weight" type="number" step="0.1" placeholder="75.5"></div>
      <div class="inp-group"><label class="label">Date</label><input class="inp" id="meas-date" type="date"></div>
      <div class="inp-group"><label class="label">Notes</label><input class="inp" id="meas-notes" placeholder="How are you feeling?"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-ghost" style="flex:1" onclick="closeMeasurementModal()">Cancel</button>
        <button class="btn btn-lime" style="flex:1" onclick="saveMeasurement()">Save</button>
      </div>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://oxpeybhsucryghtrnhmm.supabase.co';
const SUPABASE_KEY = 'sb_publishable_2kifid9YD_4BFq_cDIUFLg_1wsMkG2W';

let db,currentUser,currentProfile;
let exercises=[],myClients=[],myPlans=[],measurements=[],logCache={};
let cart=[];
let weightChart,volumeChart,editingExId=null;

const catColors={Legs:'#4488FF',Chest:'#FF6B35',Back:'#9B6DFF',Shoulders:'#D4FF00',Arms:'#00E676',Core:'#FF4444',Cardio:'#FFB800'};
const catIcons={Legs:'ğŸ¦µ',Chest:'ğŸ’ª',Back:'ğŸ‹ï¸',Shoulders:'â¬†ï¸',Arms:'ğŸ’ª',Core:'ğŸ¯',Cardio:'ğŸƒ'};
const days=['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
const dayAbbr={Monday:'Mon',Tuesday:'Tue',Wednesday:'Wed',Thursday:'Thu',Friday:'Fri',Saturday:'Sat',Sunday:'Sun'};

function toast(msg,type='success'){
  const el=document.getElementById('toast');
  el.querySelector('#toast-msg').textContent=msg;
  el.querySelector('#toast-icon').textContent=type==='success'?'âœ…':'âŒ';
  el.className=`show ${type}`;
  setTimeout(()=>el.classList.remove('show'),3500);
}

function switchTab(t){
  document.getElementById('login-form').classList.toggle('hidden',t!=='login');
  document.getElementById('signup-form').classList.toggle('hidden',t!=='signup');
  document.querySelectorAll('.auth-tab').forEach((el,i)=>el.classList.toggle('active',(i===0&&t==='login')||(i===1&&t==='signup')));
}

function toggleCodeField(){
  const role=document.getElementById('s-role').value;
  document.getElementById('trainer-code-field').classList.toggle('hidden',role!=='client');
}

async function login(){
  const email=document.getElementById('l-email').value.trim();
  const pass=document.getElementById('l-pass').value;
  if(!email||!pass)return toast('Fill in all fields','error');
  const btn=document.getElementById('login-btn');
  btn.disabled=true;btn.textContent='Signing in...';
  const {error}=await db.auth.signInWithPassword({email,password:pass});
  if(error){toast(error.message,'error');btn.disabled=false;btn.textContent='Sign In';}
}

async function signup(){
  const name=document.getElementById('s-name').value.trim();
  const email=document.getElementById('s-email').value.trim();
  const pass=document.getElementById('s-pass').value;
  const role=document.getElementById('s-role').value;
  const code=document.getElementById('s-trainer-code')?.value.trim().toUpperCase();
  if(!name||!email||!pass)return toast('Fill in all fields','error');
  const {data,error}=await db.auth.signUp({email,password:pass,options:{data:{full_name:name,role}}});
  if(error)return toast(error.message,'error');
  if(role==='client'&&code&&data.user){
    setTimeout(async()=>{
      const {data:tr}=await db.from('profiles').select('id').eq('trainer_code',code).maybeSingle();
      if(tr)await db.from('profiles').update({trainer_id:tr.id}).eq('id',data.user.id);
    },2000);
  }
  toast('Account created! Check your email then sign in.');
  switchTab('login');
}

async function logout(){await db.auth.signOut();location.reload();}

async function bootApp(user){
  currentUser=user;
  const {data:profile}=await db.from('profiles').select('*').eq('id',user.id).single();
  if(!profile){
    toast('Profile not found. Try refreshing.','error');
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('auth-screen').classList.remove('hidden');
    return;
  }
  currentProfile=profile;
  renderNav(profile.role);
  updateUserUI(profile);
  if(profile.role==='admin')await bootAdmin();
  else if(profile.role==='trainer')await bootTrainer();
  else await bootClient();
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('auth-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
}

function updateUserUI(p){
  const ini=(p.full_name||p.email).split(' ').map(x=>x[0]).join('').toUpperCase().slice(0,2);
  ['sidebar-avatar','top-avatar'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=ini;});
  document.getElementById('sidebar-name').textContent=p.full_name||p.email;
  document.getElementById('sidebar-role').textContent=p.role.charAt(0).toUpperCase()+p.role.slice(1);
}

const navConfig={
  admin:[{icon:'ğŸ“Š',label:'Overview',page:'admin-overview'},{icon:'ğŸ‹ï¸',label:'Exercises',page:'admin-exercises'},{icon:'ğŸ‘¥',label:'All Users',page:'admin-users'}],
  trainer:[{icon:'ğŸ“Š',label:'Dashboard',page:'trainer-overview'},{icon:'âœï¸',label:'Build Plan',page:'trainer-build'},{icon:'ğŸ‘¥',label:'My Clients',page:'trainer-clients'},{icon:'ğŸ“‹',label:'Active Plans',page:'trainer-plans'}],
  client:[{icon:'ğŸƒ',label:'Today',page:'client-today'},{icon:'ğŸ“ˆ',label:'Progress',page:'client-progress'},{icon:'ğŸ“‹',label:'My Plan',page:'client-plan'},{icon:'ğŸ‘¤',label:'Profile',page:'client-profile'}]
};

function renderNav(role){
  const nav=navConfig[role]||[];
  ['nav-items','mobile-nav'].forEach(id=>document.getElementById(id).innerHTML='');
  nav.forEach((item,i)=>{
    const si=document.createElement('div');
    si.className='nav-item'+(i===0?' active':'');
    si.innerHTML=`<span class="ni-icon">${item.icon}</span><span>${item.label}</span>`;
    si.onclick=()=>showPage(item.page,si,false);
    document.getElementById('nav-items').appendChild(si);
    const mi=document.createElement('div');
    mi.className='mnav-item'+(i===0?' active':'');
    mi.innerHTML=`<span>${item.icon}</span><span>${item.label.split(' ')[0]}</span>`;
    mi.onclick=()=>showPage(item.page,mi,true);
    document.getElementById('mobile-nav').appendChild(mi);
  });
  showPage(nav[0].page,null,false);
}

function showPage(pageId,clickedEl,isMobile){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  const page=document.getElementById('page-'+pageId);
  if(page)page.classList.add('active');
  if(clickedEl){
    const sel=isMobile?'.mnav-item':'.nav-item';
    document.querySelectorAll(sel).forEach(e=>e.classList.remove('active'));
    clickedEl.classList.add('active');
    const other=isMobile?document.querySelectorAll('.nav-item'):document.querySelectorAll('.mnav-item');
    const src=isMobile?document.querySelectorAll('.mnav-item'):document.querySelectorAll('.nav-item');
    const idx=Array.from(src).indexOf(clickedEl);
    if(other[idx]){other.forEach(e=>e.classList.remove('active'));other[idx].classList.add('active');}
  }
  document.getElementById('sidebar').classList.remove('open');
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');}

// â”€â”€ ADMIN â”€â”€
async function bootAdmin(){
  const [{data:exData},{count:exC},{data:users}]=await Promise.all([
    db.from('exercises').select('*').order('category').order('name'),
    db.from('exercises').select('*',{count:'exact',head:true}),
    db.from('profiles').select('*').order('created_at',{ascending:false})
  ]);
  exercises=exData||[];
  document.getElementById('stat-ex').textContent=exC||0;
  document.getElementById('stat-tr').textContent=users?.filter(u=>u.role==='trainer').length||0;
  document.getElementById('stat-cl').textContent=users?.filter(u=>u.role==='client').length||0;
  const html=users?.length?users.map(u=>`
    <div class="client-row">
      <div class="avatar">${(u.full_name||u.email).charAt(0).toUpperCase()}</div>
      <div style="flex:1">
        <div style="font-weight:600">${u.full_name||'â€”'}</div>
        <div class="muted" style="font-size:.8rem">${u.email}</div>
        ${u.trainer_code?`<div style="font-size:.75rem;color:var(--lime);margin-top:2px">Code: ${u.trainer_code}</div>`:''}
      </div>
      <span class="badge badge-${u.role==='admin'?'lime':u.role==='trainer'?'blue':'green'}">${u.role}</span>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-ghost btn-sm" onclick="changeRole('${u.id}','trainer')">â†’ Trainer</button>
        <button class="btn btn-ghost btn-sm" onclick="changeRole('${u.id}','client')">â†’ Client</button>
      </div>
    </div>`).join(''):'<div class="empty"><div class="empty-icon">ğŸ‘¥</div><h3>No users yet</h3></div>';
  ['admin-users-list','admin-users-full'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=html;});
  renderAdminExercises();
}

async function loadAllUsers(){
  const {data}=await db.from('profiles').select('*').order('created_at',{ascending:false});
  const html=data?.length?data.map(u=>`
    <div class="client-row">
      <div class="avatar">${(u.full_name||u.email).charAt(0).toUpperCase()}</div>
      <div style="flex:1">
        <div style="font-weight:600">${u.full_name||'â€”'}</div>
        <div class="muted" style="font-size:.8rem">${u.email}</div>
        ${u.trainer_code?`<div style="font-size:.75rem;color:var(--lime);margin-top:2px">Code: ${u.trainer_code}</div>`:''}
      </div>
      <span class="badge badge-${u.role==='admin'?'lime':u.role==='trainer'?'blue':'green'}">${u.role}</span>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-ghost btn-sm" onclick="changeRole('${u.id}','trainer')">â†’ Trainer</button>
        <button class="btn btn-ghost btn-sm" onclick="changeRole('${u.id}','client')">â†’ Client</button>
      </div>
    </div>`).join(''):'<div class="empty"><div class="empty-icon">ğŸ‘¥</div><h3>No users yet</h3></div>';
  ['admin-users-list','admin-users-full'].forEach(id=>{const el=document.getElementById(id);if(el)el.innerHTML=html;});
}

async function changeRole(uid,role){
  let updates={role};
  if(role==='trainer'){
    const {data:p}=await db.from('profiles').select('full_name').eq('id',uid).single();
    updates.trainer_code=(p?.full_name||'TRN').substring(0,3).toUpperCase()+'-'+Math.floor(Math.random()*9000+1000);
  }
  const {error}=await db.from('profiles').update(updates).eq('id',uid);
  if(error)toast(error.message,'error');
  else{toast('Role updated!');loadAllUsers();}
}

async function loadExercises(){
  const {data}=await db.from('exercises').select('*').order('category').order('name');
  exercises=data||[];
}

function renderAdminExercises(filter='All'){
  const list=document.getElementById('admin-ex-list');
  const shown=filter==='All'?exercises:exercises.filter(e=>e.category===filter);
  list.innerHTML=shown.length?shown.map(ex=>`
    <div class="ex-card" style="cursor:default">
      <div class="ex-icon" style="background:${catColors[ex.category]}22;color:${catColors[ex.category]}">${catIcons[ex.category]||'ğŸ‹ï¸'}</div>
      <div class="ex-info">
        <div class="ex-name">${ex.name}</div>
        <div class="ex-meta">${ex.default_sets}Ã—${ex.default_reps} Â· ${ex.category}</div>
        ${ex.notes?`<div class="ex-meta" style="color:var(--text3);font-size:.72rem;margin-top:2px">${ex.notes.substring(0,55)}${ex.notes.length>55?'...':''}</div>`:''}
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn btn-ghost btn-sm btn-icon" onclick="openExModal('${ex.id}')">âœï¸</button>
        <button class="btn btn-danger btn-sm btn-icon" onclick="deleteExercise('${ex.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`).join(''):'<div class="empty"><div class="empty-icon">ğŸ‹ï¸</div><h3>No exercises</h3></div>';
}
function filterAdminEx(cat,el){document.querySelectorAll('#admin-cat-filters .cat-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');renderAdminExercises(cat);}
function openExModal(id=''){
  editingExId=id;const ex=id?exercises.find(e=>e.id===id):null;
  document.getElementById('ex-modal-title').textContent=ex?'Edit Exercise':'Add Exercise';
  document.getElementById('ex-name').value=ex?.name||'';
  document.getElementById('ex-cat').value=ex?.category||'Legs';
  document.getElementById('ex-sets').value=ex?.default_sets||3;
  document.getElementById('ex-reps').value=ex?.default_reps||'10-15';
  document.getElementById('ex-url').value=ex?.tutorial_url||'';
  document.getElementById('ex-notes').value=ex?.notes||'';
  document.getElementById('ex-modal').classList.remove('hidden');
}
function closeExModal(){document.getElementById('ex-modal').classList.add('hidden');}
async function saveExercise(){
  const data={name:document.getElementById('ex-name').value.trim(),category:document.getElementById('ex-cat').value,default_sets:parseInt(document.getElementById('ex-sets').value)||3,default_reps:document.getElementById('ex-reps').value.trim(),tutorial_url:document.getElementById('ex-url').value.trim()||null,notes:document.getElementById('ex-notes').value.trim()||null,created_by:currentUser.id};
  if(!data.name)return toast('Name required','error');
  const {error}=editingExId?await db.from('exercises').update(data).eq('id',editingExId):await db.from('exercises').insert(data);
  if(error)toast(error.message,'error');
  else{toast(editingExId?'Updated!':'Added!');closeExModal();await loadExercises();renderAdminExercises();}
}
async function deleteExercise(id){
  if(!confirm('Delete this exercise?'))return;
  const {error}=await db.from('exercises').delete().eq('id',id);
  if(error)toast(error.message,'error');
  else{toast('Deleted');await loadExercises();renderAdminExercises();}
}

// â”€â”€ TRAINER â”€â”€
async function bootTrainer(){
  const [{data:exData},{data:cl},{data:pl}]=await Promise.all([
    db.from('exercises').select('*').order('category').order('name'),
    db.from('profiles').select('*').eq('trainer_id',currentUser.id).order('full_name'),
    db.from('workout_plans').select('*,profiles!workout_plans_client_id_fkey(full_name,email),plan_exercises(*,exercises(name,category))').eq('trainer_id',currentUser.id).order('assigned_at',{ascending:false})
  ]);
  exercises=exData||[];
  myClients=cl||[];
  myPlans=pl||[];
  document.getElementById('trainer-code-display').textContent=currentProfile.trainer_code||'No code';
  document.getElementById('t-stat-clients').textContent=myClients.length;
  document.getElementById('t-stat-plans').textContent=myPlans.length;
  renderTrainerClientsMini();
  renderTrainerExercises();
  renderTrainerClientsFull();
  renderTrainerPlans();
  document.getElementById('cart-trigger').classList.remove('hidden');
  populateCartClients();
}

function copyCode(){navigator.clipboard.writeText(currentProfile.trainer_code||'');toast('Code copied!');}

function renderTrainerClientsMini(){
  const el=document.getElementById('trainer-clients-mini');
  el.innerHTML=myClients.length?myClients.slice(0,5).map(c=>`<div class="client-row"><div class="avatar">${(c.full_name||c.email).charAt(0).toUpperCase()}</div><div><div style="font-weight:600">${c.full_name||'â€”'}</div><div class="muted" style="font-size:.8rem">${c.email}</div></div></div>`).join(''):'<div class="empty" style="padding:30px"><div class="empty-icon">ğŸ‘¥</div><h3>No clients yet</h3><p>Share your trainer code with clients</p></div>';
}
function renderTrainerClientsFull(){
  const el=document.getElementById('trainer-clients-full');
  el.innerHTML=myClients.length?myClients.map(c=>`<div class="client-row"><div class="avatar avatar-lg">${(c.full_name||c.email).charAt(0).toUpperCase()}</div><div style="flex:1"><div style="font-weight:600;font-size:1rem">${c.full_name||'â€”'}</div><div class="muted">${c.email}</div></div><span class="badge badge-green">Active</span></div>`).join(''):'<div class="empty"><div class="empty-icon">ğŸ‘¥</div><h3>No clients linked</h3><p>Trainer code: <strong style="color:var(--lime)">'+(currentProfile.trainer_code||'â€”')+'</strong></p></div>';
}
function renderTrainerPlans(){
  const el=document.getElementById('trainer-plans-list');
  el.innerHTML=myPlans.length?myPlans.map(p=>{
    const c=p.profiles;const dm={};
    p.plan_exercises?.forEach(e=>{if(!dm[e.day_of_week])dm[e.day_of_week]=[];dm[e.day_of_week].push(e);});
    return `<div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;flex-wrap:wrap;gap:8px">
        <div><div style="font-family:'Syne',sans-serif;font-weight:700">${p.name}</div><div class="muted" style="font-size:.85rem;margin-top:2px">â†’ ${c?.full_name||c?.email||'Unknown'}</div></div>
        <div style="display:flex;gap:8px;align-items:center"><span class="badge badge-${p.active?'green':'red'}">${p.active?'Active':'Inactive'}</span><button class="btn btn-danger btn-sm" onclick="deletePlan('${p.id}')">Delete</button></div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">${Object.entries(dm).map(([d,ex])=>`<span class="badge badge-blue">${d.substring(0,3)}: ${ex.length}</span>`).join('')||'<span class="muted">No exercises</span>'}</div>
    </div>`;
  }).join(''):'<div class="empty"><div class="empty-icon">ğŸ“‹</div><h3>No plans sent yet</h3><p>Use "Build Plan" to create and send plans</p></div>';
}

function renderTrainerExercises(filter='All'){
  const grid=document.getElementById('trainer-ex-grid');
  const shown=filter==='All'?exercises:exercises.filter(e=>e.category===filter);
  grid.innerHTML=shown.length?shown.map(ex=>{
    const inCart=cart.some(c=>c.exercise_id===ex.id);
    return `<div class="ex-card ${inCart?'in-cart':''}" id="excard-${ex.id}" onclick="toggleCart_Item('${ex.id}')">
      <div class="cart-check">âœ“</div>
      <div class="ex-icon" style="background:${catColors[ex.category]}22;color:${catColors[ex.category]}">${catIcons[ex.category]||'ğŸ‹ï¸'}</div>
      <div class="ex-info">
        <div class="ex-name">${ex.name}</div>
        <div class="ex-meta">${ex.default_sets}Ã—${ex.default_reps}</div>
        ${ex.notes?`<div class="ex-meta" style="color:var(--text3);font-size:.72rem;margin-top:2px">${ex.notes.substring(0,45)}${ex.notes.length>45?'...':''}</div>`:''}
      </div>
      <span class="badge" style="background:${catColors[ex.category]}22;color:${catColors[ex.category]};align-self:flex-start;flex-shrink:0;font-size:.65rem">${ex.category}</span>
    </div>`;
  }).join(''):'<div class="empty"><div class="empty-icon">ğŸ‹ï¸</div><h3>No exercises</h3></div>';
}
function filterTrainerEx(filter,el){document.querySelectorAll('#trainer-cat-filters .cat-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');renderTrainerExercises(filter);}

// CART LOGIC
function toggleCart_Item(exId){
  const ex=exercises.find(e=>e.id===exId);
  const idx=cart.findIndex(c=>c.exercise_id===exId);
  if(idx>-1){cart.splice(idx,1);}
  else{
    cart.push({exercise_id:exId,name:ex.name,category:ex.category,day:'Monday',sets:ex.default_sets||3,reps:ex.default_reps||'10-15'});
    const btn=document.getElementById('cart-trigger');btn.classList.add('bounce');setTimeout(()=>btn.classList.remove('bounce'),300);
  }
  const card=document.getElementById('excard-'+exId);
  if(card)card.classList.toggle('in-cart',idx===-1);
  updateCartUI();
}
function toggleCart(){document.getElementById('cart-panel').classList.toggle('open');}
function updateCartUI(){
  const n=cart.length;
  const cc=document.getElementById('cart-count');cc.textContent=n;cc.classList.toggle('hidden',n===0);
  const cl=document.getElementById('cart-count-label');if(cl)cl.textContent=n;
  const body=document.getElementById('cart-body');
  if(!n){body.innerHTML='<div class="empty" style="padding:40px 20px"><div class="empty-icon">ğŸ›’</div><h3>Cart empty</h3><p>Click exercises to add them</p></div>';return;}
  body.innerHTML=cart.map((item,i)=>`
    <div class="cart-item">
      <button class="cart-remove" onclick="removeFromCart(${i})">âœ•</button>
      <div class="cart-item-name">${catIcons[item.category]||'ğŸ‹ï¸'} ${item.name}</div>
      <select class="cart-day-sel" onchange="updateCartItem(${i},'day',this.value)">
        ${days.map(d=>`<option ${item.day===d?'selected':''}>${d}</option>`).join('')}
      </select>
      <div class="cart-sets-row">
        <div><div class="label" style="margin-bottom:4px;font-size:.65rem">Sets</div><input class="cart-mini-inp" type="number" value="${item.sets}" min="1" onchange="updateCartItem(${i},'sets',this.value)"></div>
        <div><div class="label" style="margin-bottom:4px;font-size:.65rem">Reps</div><input class="cart-mini-inp" type="text" value="${item.reps}" onchange="updateCartItem(${i},'reps',this.value)"></div>
      </div>
    </div>`).join('');
}
function updateCartItem(i,field,val){if(field==='sets')cart[i].sets=parseInt(val)||3;else cart[i][field]=val;}
function removeFromCart(i){const id=cart[i].exercise_id;cart.splice(i,1);const c=document.getElementById('excard-'+id);if(c)c.classList.remove('in-cart');updateCartUI();}
function clearCart(){cart.forEach(c=>{const el=document.getElementById('excard-'+c.exercise_id);if(el)el.classList.remove('in-cart');});cart=[];updateCartUI();}
function populateCartClients(){
  const sel=document.getElementById('cart-client-sel');
  sel.innerHTML='<option value="">â€” Select Client â€”</option>'+myClients.map(c=>`<option value="${c.id}">${c.full_name||c.email}</option>`).join('');
}
async function sendPlan(){
  const name=document.getElementById('cart-plan-name').value.trim();
  const clientId=document.getElementById('cart-client-sel').value;
  if(!name)return toast('Give the plan a name','error');
  if(!clientId)return toast('Select a client','error');
  if(!cart.length)return toast('Cart is empty!','error');
  const {data:plan,error}=await db.from('workout_plans').insert({name,client_id:clientId,trainer_id:currentUser.id,active:true}).select().single();
  if(error)return toast(error.message,'error');
  const rows=cart.map((item,i)=>({plan_id:plan.id,exercise_id:item.exercise_id,day_of_week:item.day,sets:item.sets,reps:item.reps,order_index:i}));
  const {error:e2}=await db.from('plan_exercises').insert(rows);
  if(e2)return toast(e2.message,'error');
  toast('Plan sent! ğŸ‰');clearCart();
  document.getElementById('cart-plan-name').value='';
  document.getElementById('cart-panel').classList.remove('open');
  const {data:pl}=await db.from('workout_plans').select('*,profiles!workout_plans_client_id_fkey(full_name,email),plan_exercises(*,exercises(name,category))').eq('trainer_id',currentUser.id).order('assigned_at',{ascending:false});
  myPlans=pl||[];renderTrainerPlans();
  document.getElementById('t-stat-plans').textContent=myPlans.length;
}
async function deletePlan(id){
  if(!confirm('Delete this plan?'))return;
  await db.from('workout_plans').delete().eq('id',id);
  toast('Plan deleted');
  const {data:pl}=await db.from('workout_plans').select('*,profiles!workout_plans_client_id_fkey(full_name,email),plan_exercises(*,exercises(name,category))').eq('trainer_id',currentUser.id).order('assigned_at',{ascending:false});
  myPlans=pl||[];renderTrainerPlans();
  document.getElementById('t-stat-plans').textContent=myPlans.length;
}

// â”€â”€ CLIENT â”€â”€
let clientPlan=null,clientPlanExercises=[],selectedDay=null;
async function bootClient(){
  const today=new Date().toISOString().split('T')[0];
  const [{data:planData},{data:measData},{data:logsData}]=await Promise.all([
    db.from('workout_plans').select('*,plan_exercises(*,exercises(*))').eq('client_id',currentUser.id).eq('active',true).order('assigned_at',{ascending:false}).limit(1).maybeSingle(),
    db.from('body_measurements').select('*').eq('client_id',currentUser.id).order('measured_at',{ascending:false}),
    db.from('exercise_logs').select('*').eq('client_id',currentUser.id).eq('workout_date',today)
  ]);
  clientPlan=planData;
  clientPlanExercises=planData?.plan_exercises||[];
  measurements=measData||[];
  logCache={};logsData?.forEach(l=>{logCache[`${l.exercise_id}-${l.set_number}`]=l;});
  if(measurements.length)document.getElementById('current-weight').textContent=measurements[0].weight_kg;
  renderClientToday();renderClientPlan();renderClientProfile();initCharts();
}
async function loadClientPlan(){
  const {data}=await db.from('workout_plans').select('*,plan_exercises(*,exercises(*))').eq('client_id',currentUser.id).eq('active',true).order('assigned_at',{ascending:false}).limit(1).maybeSingle();
  clientPlan=data;clientPlanExercises=data?.plan_exercises||[];
}
async function loadTodayLogs(){
  const today=new Date().toISOString().split('T')[0];
  const {data}=await db.from('exercise_logs').select('*').eq('client_id',currentUser.id).eq('workout_date',today);
  logCache={};data?.forEach(l=>{logCache[`${l.exercise_id}-${l.set_number}`]=l;});
}
function getTodayName(){return days[new Date().getDay()===0?6:new Date().getDay()-1];}
function renderClientToday(){
  const today=getTodayName();selectedDay=today;
  document.getElementById('client-day-label').textContent=today;
  document.getElementById('client-day-tabs').innerHTML=days.map(d=>`<div class="day-tab ${d===today?'active':''}" onclick="selectClientDay('${d}',this)">${dayAbbr[d]}</div>`).join('');
  renderDayWorkout(today);
}
function selectClientDay(day,el){selectedDay=day;document.querySelectorAll('#client-day-tabs .day-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');document.getElementById('client-day-label').textContent=day;renderDayWorkout(day);}
function renderDayWorkout(day){
  const container=document.getElementById('client-workout-list');
  if(!clientPlan){container.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“‹</div><h3>No plan assigned yet</h3><p>Your trainer will send you a workout plan</p></div>';return;}
  const dayExs=clientPlanExercises.filter(e=>e.day_of_week===day).sort((a,b)=>a.order_index-b.order_index);
  if(!dayExs.length){container.innerHTML='<div class="empty"><div class="empty-icon">ğŸ§˜</div><h3>Rest Day</h3><p>No workout for '+day+'</p></div>';return;}
  container.innerHTML=dayExs.map((we,wi)=>{
    const ex=we.exercises;const sets=we.sets||3;
    const setRows=Array.from({length:sets},(_,si)=>{
      const key=`${ex.id}-${si+1}`;const log=logCache[key];
      return `<div class="set-row">
        <div class="set-num">S${si+1}</div>
        <input class="set-inp" type="number" step="0.5" placeholder="kg" value="${log?.weight_kg||''}" id="w-${wi}-${si}-kg" onchange="autoSave('${ex.id}',${si+1},${wi},${si})">
        <input class="set-inp" type="number" placeholder="reps" value="${log?.reps_completed||''}" id="w-${wi}-${si}-r" onchange="autoSave('${ex.id}',${si+1},${wi},${si})">
        <button class="check-btn ${log?.completed?'checked':''}" id="chk-${wi}-${si}" onclick="toggleSet('${ex.id}',${si+1},${wi},${si})">${log?.completed?'âœ“':''}</button>
      </div>`;
    }).join('');
    const allDone=Array.from({length:sets},(_,si)=>logCache[`${ex.id}-${si+1}`]?.completed).every(Boolean);
    return `<div class="workout-ex ${allDone?'done':''}" id="wex-${wi}">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="ex-icon" style="background:${catColors[ex.category]||'#333'}22;color:${catColors[ex.category]||'#888'}">${catIcons[ex.category]||'ğŸ‹ï¸'}</div>
          <div><div style="font-weight:700">${ex.name}</div><div class="muted" style="font-size:.8rem">${sets} sets Ã— ${we.reps||'10-15'} reps</div></div>
        </div>
        ${ex.tutorial_url?`<a href="${ex.tutorial_url}" target="_blank" class="btn btn-ghost btn-sm">â–¶ Tutorial</a>`:''}
      </div>
      <div style="margin-top:8px">
        <div style="display:grid;grid-template-columns:40px 1fr 1fr 48px;gap:8px;margin-bottom:4px">
          <div></div><div class="label" style="text-align:center">Weight</div><div class="label" style="text-align:center">Reps</div><div></div>
        </div>
        ${setRows}
      </div>
      ${ex.notes?`<div style="margin-top:10px;padding:8px 12px;background:var(--bg3);border-radius:10px;font-size:.8rem;color:var(--text2)">ğŸ’¡ ${ex.notes}</div>`:''}
    </div>`;
  }).join('');
}
async function autoSave(exId,setNum,wi,si){
  const kg=parseFloat(document.getElementById(`w-${wi}-${si}-kg`).value)||null;
  const reps=parseInt(document.getElementById(`w-${wi}-${si}-r`).value)||null;
  const today=new Date().toISOString().split('T')[0];
  const key=`${exId}-${setNum}`;const existing=logCache[key];
  const data={client_id:currentUser.id,exercise_id:exId,workout_date:today,set_number:setNum,weight_kg:kg,reps_completed:reps};
  if(existing){await db.from('exercise_logs').update(data).eq('id',existing.id);logCache[key]={...existing,...data};}
  else{const {data:nl}=await db.from('exercise_logs').insert({...data,completed:false}).select().single();if(nl)logCache[key]=nl;}
}
async function toggleSet(exId,setNum,wi,si){
  const key=`${exId}-${setNum}`;const today=new Date().toISOString().split('T')[0];const existing=logCache[key];const newVal=!existing?.completed;
  if(existing){await db.from('exercise_logs').update({completed:newVal}).eq('id',existing.id);logCache[key]={...existing,completed:newVal};}
  else{const {data:nl}=await db.from('exercise_logs').insert({client_id:currentUser.id,exercise_id:exId,workout_date:today,set_number:setNum,completed:true}).select().single();if(nl)logCache[key]=nl;}
  const btn=document.getElementById(`chk-${wi}-${si}`);btn.classList.toggle('checked',newVal);btn.textContent=newVal?'âœ“':'';
}
function renderClientPlan(){
  const el=document.getElementById('client-plan-view');
  if(!clientPlan){el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“‹</div><h3>No plan yet</h3><p>Your trainer will send you a plan soon</p></div>';return;}
  const dm={};clientPlanExercises.forEach(e=>{if(!dm[e.day_of_week])dm[e.day_of_week]=[];dm[e.day_of_week].push(e);});
  el.innerHTML=`<div class="card" style="margin-bottom:16px"><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:1.1rem">${clientPlan.name}</div></div>`+
    days.map(day=>{const exs=dm[day]||[];return `<div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:${exs.length?'12px':'0'}">
        <div style="font-family:'Syne',sans-serif;font-weight:700">${day}</div>
        ${!exs.length?'<span class="badge badge-purple">Rest</span>':'<span class="badge badge-lime">'+exs.length+' exercises</span>'}
      </div>
      ${exs.map(e=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
        <div class="ex-icon" style="width:32px;height:32px;border-radius:10px;background:${catColors[e.exercises?.category]||'#333'}22;color:${catColors[e.exercises?.category]||'#888'};font-size:.85rem">${catIcons[e.exercises?.category]||'ğŸ‹ï¸'}</div>
        <div style="flex:1"><div style="font-weight:600;font-size:.9rem">${e.exercises?.name||'?'}</div><div class="muted" style="font-size:.75rem">${e.sets}Ã—${e.reps}</div></div>
      </div>`).join('')}
    </div>`;}).join('');
}
async function loadMeasurements(){
  const {data}=await db.from('body_measurements').select('*').eq('client_id',currentUser.id).order('measured_at',{ascending:false});
  measurements=data||[];
  if(measurements.length)document.getElementById('current-weight').textContent=measurements[0].weight_kg;
}
function openMeasurementModal(){document.getElementById('meas-date').value=new Date().toISOString().split('T')[0];document.getElementById('meas-weight').value='';document.getElementById('meas-notes').value='';document.getElementById('meas-modal').classList.remove('hidden');}
function closeMeasurementModal(){document.getElementById('meas-modal').classList.add('hidden');}
async function saveMeasurement(){
  const weight=parseFloat(document.getElementById('meas-weight').value);
  const date=document.getElementById('meas-date').value;
  const notes=document.getElementById('meas-notes').value.trim();
  if(!weight||!date)return toast('Weight and date required','error');
  const {error}=await db.from('body_measurements').insert({client_id:currentUser.id,weight_kg:weight,measured_at:date,notes:notes||null});
  if(error)toast(error.message,'error');
  else{toast('Weight logged! ğŸ‰');closeMeasurementModal();await loadMeasurements();renderClientProfile();updateCharts();}
}
function renderClientProfile(){
  const p=currentProfile;
  const ini=(p.full_name||p.email).split(' ').map(x=>x[0]).join('').toUpperCase().slice(0,2);
  const av=document.getElementById('profile-avatar');if(av)av.textContent=ini;
  const pn=document.getElementById('profile-name');if(pn)pn.textContent=p.full_name||'â€”';
  const pe=document.getElementById('profile-email');if(pe)pe.textContent=p.email;
  const pb=document.getElementById('profile-badge');if(pb)pb.innerHTML='<span class="badge badge-green">Client</span>';
  const table=document.getElementById('measurements-table');
  if(!measurements.length){table.innerHTML='<div class="muted" style="text-align:center;padding:20px">No weight logs yet</div>';return;}
  table.innerHTML=measurements.slice(0,10).map(m=>`<div style="display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)"><div style="font-size:.9rem">${new Date(m.measured_at+'T12:00:00').toLocaleDateString('en-IN',{month:'short',day:'numeric',year:'numeric'})}</div><div style="font-family:'Syne',sans-serif;font-weight:700">${m.weight_kg} kg</div></div>`).join('');
}
function initCharts(){
  const opts={responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{backgroundColor:'#1a1a1a',borderColor:'#333',borderWidth:1,titleColor:'#fff',bodyColor:'#888'}},scales:{x:{grid:{color:'#1f1f1f'},ticks:{color:'#555',font:{size:10}}},y:{grid:{color:'#1f1f1f'},ticks:{color:'#555',font:{size:10}}}}};
  weightChart=new Chart(document.getElementById('weight-chart').getContext('2d'),{type:'line',data:{labels:[],datasets:[{data:[],borderColor:'#D4FF00',backgroundColor:'rgba(212,255,0,.1)',tension:.4,pointBackgroundColor:'#D4FF00',pointRadius:4,fill:true}]},options:opts});
  volumeChart=new Chart(document.getElementById('volume-chart').getContext('2d'),{type:'bar',data:{labels:[],datasets:[{data:[],backgroundColor:'rgba(68,136,255,.6)',borderRadius:8,borderSkipped:false}]},options:opts});
  updateCharts();
}
async function updateCharts(){
  const sorted=[...measurements].sort((a,b)=>new Date(a.measured_at)-new Date(b.measured_at)).slice(-15);
  weightChart.data.labels=sorted.map(m=>new Date(m.measured_at+'T12:00:00').toLocaleDateString('en-IN',{month:'short',day:'numeric'}));
  weightChart.data.datasets[0].data=sorted.map(m=>m.weight_kg);weightChart.update();
  const last7=Array.from({length:7},(_,i)=>{const d=new Date();d.setDate(d.getDate()-6+i);return d.toISOString().split('T')[0];});
  const {data:logs}=await db.from('exercise_logs').select('workout_date,reps_completed').eq('client_id',currentUser.id).eq('completed',true).in('workout_date',last7);
  const vol={};last7.forEach(d=>vol[d]=0);logs?.forEach(l=>{if(vol[l.workout_date]!==undefined)vol[l.workout_date]+=(l.reps_completed||0);});
  volumeChart.data.labels=last7.map(d=>new Date(d+'T12:00:00').toLocaleDateString('en-IN',{month:'short',day:'numeric'}));
  volumeChart.data.datasets[0].data=last7.map(d=>vol[d]);volumeChart.update();
  const wDone=last7.filter(d=>vol[d]>0).length;const wEl=document.getElementById('workouts-done');if(wEl)wEl.textContent=wDone;
}

async function init(){
  try{
    db=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
    const {data:{session}}=await db.auth.getSession();
    if(session?.user)await bootApp(session.user);
    else{document.getElementById('loading').classList.add('hidden');document.getElementById('auth-screen').classList.remove('hidden');}
    db.auth.onAuthStateChange(async(event,session)=>{
      if(event==='SIGNED_IN'&&session?.user){document.getElementById('loading').classList.remove('hidden');await bootApp(session.user);}
    });
  }catch(err){
    console.error(err);
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('auth-screen').classList.remove('hidden');
    toast('Connection failed â€” check Supabase config','error');
  }
}
init();
</script>
</body>
</html>
